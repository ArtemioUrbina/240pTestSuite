#include <kos.h>
#include <kos/string.h>

#include "menu.h"
#include "vmodes.h"
#include <stdlib.h>

#define SAVE_NUM	120
#define	DATA_SIZE	32

unsigned char sd_data[544]=
{
	0x00,0xF0,0x22,0xF2,0x22,0xF4,0x42,0xF6,0x62,0xF9,0x94,
	0xFB,0x96,0xFD,0xDB,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x32,
	0x20,0x00,0x00,0x22,0x22,0x22,0x23,0x30,0x00,0x22,0x22,
	0x22,0x00,0x02,0x22,0x22,0x06,0x66,0x66,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x02,0x23,0x06,0x60,0x22,0x02,0x06,
	0x66,0x66,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x70,0x22,
	0x30,0x60,0x20,0x22,0x06,0x66,0x77,0x77,0x77,0x77,0x77,
	0x77,0x77,0x77,0x77,0x02,0x30,0x60,0x23,0x22,0x06,0x66,
	0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x02,0x30,
	0x60,0x22,0x22,0x06,0x67,0x77,0x77,0x77,0x77,0x77,0x77,
	0x77,0x77,0x70,0x22,0x06,0x60,0x22,0x20,0x66,0x67,0x77,
	0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x00,0x76,0x66,
	0x22,0x20,0x66,0x67,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
	0x77,0x77,0x77,0x76,0x66,0x02,0x06,0x66,0x67,0x77,0x77,
	0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x76,0x66,0x02,
	0x06,0x66,0x67,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
	0x77,0x77,0x76,0x66,0x60,0x06,0x66,0x66,0x77,0x77,0x77,
	0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x66,0x66,0x60,0x06,
	0x66,0x66,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
	0x77,0x66,0x66,0x60,0x06,0x66,0x60,0x00,0x07,0x77,0x77,
	0x77,0x77,0x77,0x77,0x70,0x00,0x06,0x66,0x60,0x06,0x67,
	0x00,0x70,0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,0x07,
	0x00,0x66,0x60,0x06,0x77,0x76,0x00,0x00,0x00,0x00,0x77,
	0x77,0x00,0x00,0x00,0x00,0x67,0x77,0x60,0x30,0x77,0x70,
	0x05,0x00,0x00,0x00,0x67,0x76,0x00,0x00,0x00,0x50,0x07,
	0x77,0x60,0x30,0x77,0x70,0x80,0x00,0x80,0x86,0x67,0x76,
	0x68,0x08,0x00,0x08,0x07,0x77,0x03,0x40,0x77,0x70,0x80,
	0x30,0x00,0x86,0x77,0x77,0x68,0x00,0x03,0x08,0x07,0x77,
	0x03,0x00,0x67,0x70,0x80,0x35,0x30,0x87,0x77,0x77,0x78,
	0x03,0x53,0x08,0x07,0x76,0x04,0x70,0x67,0x77,0x88,0x00,
	0x08,0x87,0x77,0x77,0x78,0x80,0x00,0x88,0x77,0x76,0x00,
	0x00,0x66,0x77,0x08,0x88,0x88,0x77,0x67,0x76,0x77,0x88,
	0x88,0x80,0x77,0x66,0x07,0x00,0x06,0x66,0x77,0x70,0x07,
	0x76,0x77,0x77,0x67,0x70,0x07,0x77,0x66,0x60,0x00,0x00,
	0x06,0x67,0x77,0x77,0x77,0x77,0x66,0x66,0x77,0x77,0x77,
	0x77,0x76,0x60,0x00,0x00,0x06,0x77,0x77,0x77,0x77,0x77,
	0x76,0x67,0x77,0x77,0x77,0x77,0x77,0x60,0x00,0x10,0x06,
	0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
	0x77,0x60,0x01,0x05,0x50,0x67,0x77,0x77,0x77,0x77,0x77,
	0x77,0x77,0x77,0x77,0x77,0x76,0x05,0x50,0x05,0x50,0x67,
	0x77,0x77,0x77,0x70,0x08,0x80,0x07,0x77,0x77,0x77,0x76,
	0x05,0x50,0x55,0x43,0x06,0x67,0x77,0x77,0x77,0x77,0x77,
	0x77,0x77,0x77,0x76,0x60,0x34,0x55,0x55,0x43,0x30,0x06,
	0x77,0x77,0x77,0x76,0x67,0x77,0x77,0x77,0x60,0x03,0x34,
	0x55,0x55,0x43,0x33,0x00,0x06,0x77,0x77,0x77,0x77,0x77,
	0x77,0x60,0x00,0x33,0x34,0x55,0x55,0x44,0x33,0x01,0x00,
	0x00,0x67,0x77,0x77,0x76,0x00,0x00,0x10,0x33,0x44,0x55,
	0x55,0x44,0x33,0x01,0x01,0x06,0x00,0x00,0x00,0x00,0x60,
	0x10,0x10,0x33,0x44,0x55,
};

unsigned char smpte_data[544]=
{
	0x0C,0xF0,0x24,0xF0,0xC0,0xF0,0xCC,0xF0,0x00,0xF0,0x11,
	0xF1,0x11,0xF1,0x06,0xF3,0x00,0xFC,0x0C,0xFC,0xC0,0xFC,
	0xCC,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xBB,
	0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,
	0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,
	0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,
	0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,
	0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,
	0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,
	0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,
	0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,
	0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,
	0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,
	0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,
	0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,
	0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,
	0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,
	0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,
	0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,
	0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,
	0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,
	0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,
	0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,
	0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,
	0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,
	0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,
	0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,
	0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,
	0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,
	0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,
	0x99,0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,
	0x33,0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,
	0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,
	0x98,0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,
	0x33,0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0xBB,
	0xBB,0xBA,0xAA,0xA3,0x33,0x33,0x22,0x22,0x99,0x99,0x98,
	0x88,0x80,0x00,0x00,0xBB,0xBB,0xBA,0xAA,0xA3,0x33,0x33,
	0x22,0x22,0x99,0x99,0x98,0x88,0x80,0x00,0x00,0x00,0x00,
	0x05,0x55,0x59,0x99,0x99,0x55,0x55,0x33,0x33,0x35,0x55,
	0x5B,0xBB,0xBB,0x00,0x00,0x05,0x55,0x59,0x99,0x99,0x55,
	0x55,0x33,0x33,0x35,0x55,0x5B,0xBB,0xBB,0x11,0x11,0x11,
	0xCC,0xCC,0xC7,0x77,0x77,0x75,0x55,0x55,0x54,0x55,0x65,
	0x55,0x55,0x11,0x11,0x11,0xCC,0xCC,0xC7,0x77,0x77,0x75,
	0x55,0x55,0x54,0x55,0x65,0x55,0x55,0x11,0x11,0x11,0xCC,
	0xCC,0xC7,0x77,0x77,0x75,0x55,0x55,0x54,0x55,0x65,0x55,
	0x55,0x11,0x11,0x11,0xCC,0xCC,0xC7,0x77,0x77,0x75,0x55,
	0x55,0x54,0x55,0x65,0x55,0x55,0x11,0x11,0x11,0xCC,0xCC,
	0xC7,0x77,0x77,0x75,0x55,0x55,0x54,0x55,0x65,0x55,0x55,
	0x11,0x11,0x11,0xCC,0xCC,0xC7,0x77,0x77,0x75,0x55,0x55,
	0x54,0x55,0x65,0x55,0x55,
};

int readvmu()
{
	vmu_pkg_t	pkg;
	uint8		*pkg_in = NULL;
	int		pkg_size;
	maple_device_t *dev;

	dev = maple_enum_type(0, MAPLE_FUNC_MEMCARD);
	if(!dev)
		return 0;

	vmufs_init ();

	if(vmufs_read(dev, "240PTEST", (void*)&pkg_in, &pkg_size) < 0)
		return 0;

	vmufs_shutdown ();

	if(vmu_pkg_parse(pkg_in, &pkg) != 0)
	{
		free(pkg_in);
		vmufs_delete (dev, "240PTEST");
		printf("Corrupt package, deleted save\n");
		return 0;
	}

	free(pkg_in);

	if(pkg.data_len != DATA_SIZE)
	{
		printf("Save length of unexpected size %d\n", pkg.data_len);
		return 0;
	}

	if(pkg.data[0] != SAVE_NUM)
	{
		printf("Version number differs, discarding %d != %d\n", SAVE_NUM, pkg.data[0]);
		return 0;
	}

	settings.drawborder = pkg.data[1];
        settings.EnablePAL = pkg.data[2];
        settings.PALStart = pkg.data[3];
        settings.ChangeVideoRegs = pkg.data[4];
        settings.Deflicker = pkg.data[5];
        settings.EnablePALBG = pkg.data[6];
        settings.PalBackR = pkg.data[7] / 100.0;
        settings.PalBackG = pkg.data[8] / 100.0;
        settings.PalBackB = pkg.data[9] / 100.0;
	SetScanlineIntensity((double)pkg.data[10]);
	if(!pkg.data[11])
		ToggleScanlineEvenOdd();

	return 1;
}

int writevmu(int icon)
{
	vmu_pkg_t	pkg;
	uint8		data[DATA_SIZE], *pkg_out = NULL;
	int		pkg_size;
	maple_device_t *dev;

	dev = maple_enum_type(0, MAPLE_FUNC_MEMCARD);
	if(!dev)
		return 0;

	memset(&data, 0, sizeof(uint8)*DATA_SIZE);

	data[0] = SAVE_NUM; // version number
	data[1] = settings.drawborder;
	data[2] = settings.EnablePAL;
	data[3] = settings.PALStart;
	data[4] = settings.ChangeVideoRegs;
	data[5] = settings.Deflicker;
	data[6] = settings.EnablePALBG;
	data[7] = settings.PalBackR * 100;
	data[8] = settings.PalBackG * 100;
	data[9] = settings.PalBackB * 100;
	data[10] = (int)GetScanlineIntensity();
	data[11] = ScanlinesEven();

	strcpy(pkg.desc_short, "240p Suite");
	strcpy(pkg.desc_long, "240p Test Suite Options");
	strcpy(pkg.app_id, "240p Suite");
	pkg.icon_cnt = 1;

	if(!icon)
	{
		memcpy(&pkg.icon_pal[0], smpte_data, 32);
    		pkg.icon_data = smpte_data + 32;
	}
	else
	{
		memcpy(&pkg.icon_pal[0], sd_data, 32);
    		pkg.icon_data = sd_data + 32;
	}

	pkg.icon_anim_speed = 0;
	pkg.eyecatch_type = VMUPKG_EC_NONE;
	pkg.data_len = DATA_SIZE;
	pkg.data = data;

	if(vmu_pkg_build(&pkg, &pkg_out, &pkg_size) != 0)
	{
		printf("VMU package could not be created\n");
		return 0;
	}

	vmufs_init ();
	if(vmufs_write(dev, "240PTEST", pkg_out, pkg_size, VMUFS_OVERWRITE) < 0)
	{
		printf("Writing failed\n");
		return 0;
	}
	vmufs_shutdown ();
	return 1;
}


